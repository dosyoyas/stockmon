# docker-compose.test.yml - StockMon API Test Environment
# Purpose: Orchestrates containerized API for integration testing
# Usage:
#   Start API: docker-compose -f docker-compose.test.yml up -d
#   Run tests: pytest tests/test_*_integration.py
#   Stop API: docker-compose -f docker-compose.test.yml down

version: '3.8'

services:
  api:
    # Build from Dockerfile.test in current directory
    build:
      context: .
      dockerfile: Dockerfile.test

    # Container name for easy reference
    container_name: stockmon-test-api

    # Port mapping: host:container
    ports:
      - "8000:8000"

    # Environment variables for testing
    environment:
      # API Key for test authentication
      # Override via: API_KEY=custom-key docker-compose -f docker-compose.test.yml up
      - API_KEY=${API_KEY:-test-api-key-12345}

      # Python runtime optimization
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1

    # Health check to verify API readiness
    # Tests can wait for this before executing
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Restart policy for stability during test runs
    restart: unless-stopped
